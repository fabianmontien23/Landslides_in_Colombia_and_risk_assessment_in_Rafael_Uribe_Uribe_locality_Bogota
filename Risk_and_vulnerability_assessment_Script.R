#Landslide events in Colombia and landslide risk assessment in the Rafael Uribe Uribe locality, Bogotá.
#By Wilmer Fabián Montién Tique
#University of Würzburg
#Applied Earth Observation and Geoanalysis of the Living Environment - EAGLE 
#MB2 Introduction to Programming and Geostatistics
#Würzburg, 2022
##########################################################################

#R version 4.1.2 (2021-11-01)
#Platform: x86_64-w64-mingw32/x64 (64-bit)
#Running under: Windows 10 x64 (build 22000)

##########################################################################
#This code is clustered in the following sections
#1.Registered landslides in Colombia and geolocation of the exposed goods on the interest area.
#2.Hazard and exposed elements overlapping
#3.Physical Vulnerability assessment
#4.Risk assessment 
#5.Geolocation of the exposed elements with high risk level
#6.Statistical analysis

##########################################################################
#Set the working directory
choose.dir() %>% setwd()

# Install pacman package to load libraries 
install.packages("pacman") 

# Load needed libraries
pacman::p_load(leaflet, sf, leaflet.extras, tidyverse, readxl, rgdal, ggplot2, dplyr,sp)

##########################################################################
#1.Registered landslides in Colombia and Bogotá based on the Global Landslide Catalog from the NASA's Open Data Portal.
data<-st_read("https://data.nasa.gov/api/geospatial/h9d8-neg4?method=export&format=GeoJSON") %>%
  mutate(latitude=as.numeric(latitude),
         longitude=as.numeric(longitude))%>%
  filter(country=='Colombia')

#Landslide events registered in Bogotá. Each event displays general information about the incident.
data %>%
  leaflet() %>%
  addTiles() %>%
  addPulseMarkers(lng = ~longitude,
             lat = ~latitude,
             popup = paste0("<h2>Landslide</h2>","<hr/>",
                            "Affected population:",data$population,"<hr/>",
                            "Date:",
                            data$date_,"<hr/>",
                            "Trigger:",data$trigger, 
                            "<hr/>","Fatalities:",data$fatalities,
                            "<hr/>","Injuries:",data$injuries,
                            "<hr/>","Distance:",data$distance,"<hr/>",
                            "Location:",data$location_a),
             icon=makePulseIcon(heartbeat = 2,
                                iconSize = 5))%>%
  addScaleBar() %>%
  addMiniMap()

#Load the Excel file with the 1.024 exposed goods. 
#Adapted from the Author's Specialization thesis: "Landslide risk analysis and assessment in the Rafael Uribe Uribe locality, Bogotá, Colombia."
#Available in the Catholic University of Manizales repository: Análisis y evaluación del escenario de riesgo por movimientos en masa en la localidad Rafael Uribe Uribe, Bogotá¡, Colombia, 2017." http://repositorio.ucm.edu.co:8080/jspui/handle/10839/1914?locale-attribute=en
#The files are attached in the repository.
Exposed_elements <- read_excel("Exposed_elements.xlsx") 
View(Exposed_elements)
nrow(Exposed_elements)
ncol(Exposed_elements)
colnames(Exposed_elements)

#Geolocation of the exposed elements in the Rafael Uribe Uribe locality.
    data %>%
    leaflet()%>%
    addTiles()%>%
    addPulseMarkers(lng = ~Exposed_elements$Long,
                    lat = ~Exposed_elements$Lat,
                    popup = paste0("<h2>Exposed_elements</h2>","<hr/>",
                 "Cadastral ID:",Exposed_elements$C_I_N,"<hr/>",
                 "Address:",
                 Exposed_elements$Addrs,"<hr/>",
                 "District:",Exposed_elements$Dstrc, 
                 "<hr/>","Neighborhood:",Exposed_elements$Nghbr,
                 "<hr/>","<hr/>",
                 "Predominant use:",Exposed_elements$Prdm),
  icon = makePulseIcon(heartbeat =0, iconSize = 2, color = "black"))%>%
      addScaleBar() %>%
      addMiniMap()
  
########################################################################## 
#2.Hazard and exposed elements overlapping
#Load landslide hazard map and the exposed elements on the satellite image.
#The shapefile was acquired from the open data source by the Bogotá's Institute for Risk Management and Climate Change (IDIGER)
#https://datosabiertos.bogota.gov.co/dataset/amenaza-movimientos-en-masa-urbano
#The red, green, and blue highlighted areas correspond to low, medium, and high hazard levels, respectively. 
#Bins vectors were defined based on the ranges of the hazard levels from the attributes table.Thus, the code loads this file in the viewer.
#The shapefile is attached to the repository.
hazard<-readOGR("Hazard.shp")
bins<- c(0,1, 1.1,2, 2.1, 3)
pal<-colorBin("Spectral",domain = hazard$AMENAZA, bins = bins ) 

leaflet() %>%
    addProviderTiles(
    provider = providers$Esri.WorldImagery)%>%
  addPolygons(data = hazard,
              weight=1,
              smoothFactor = 0.5,
              color="Black",
              fillOpacity = 0.5,
              fillColor = pal(hazard$H))%>%
  
  addPulseMarkers(lng = Exposed_elements$Long,
                  lat = Exposed_elements$Lat,
                  popup = paste0("<h2>Exposed_elements</h2>","<hr/>",
                                 "Cadastral ID:",Exposed_elements$C_I_N,"<hr/>", 
                                 "Address:", Exposed_elements$Addrs,"<hr/>",
                                 "District:",Exposed_elements$Dstrc,
                                 "<hr/>","Neighborhood:",Exposed_elements$Nghbr, 
                                 "<hr/>","<hr/>", 
                                 "Predominant use:",Exposed_elements$Prdm),
                  icon = makePulseIcon(heartbeat =0, iconSize = 2, color = "black"))%>%
  addScaleBar() %>%
  addMiniMap()
##########################################################################
#3.Physical Vulnerability and risk assessment
#Physical vulnerability assessment of the 1.024 exposed elements characterized in the Specialization thesis abovementioned.
#The procedure is also described in the guide for hazards, vulnerability and landslide risk by the Colombian Geological Survey institute (Servicio Geológico Colombiano)
#Available at https://www2.sgc.gov.co/Noticias/boletinesDocumentos/1642_Guia-Metodologica-27-07-2016-SinGuias.pdf

#Physical fragility estimation for the exposed elements
#The code calculates per each one of the exposed elements, the physical vulnerability based on a set of indexes to get the fragility, intensity, and vulnerability.
#A list of the field's abbreviation is attached in the repository.
#The set of indexes are:

#Definition of the structural fragility per typology (sfp)
#Definition of the structural fragility per building's height (sfb)
#Definition of the structural fragility due to conservation (sfc)
##Definition of the structural fragility due to the year of construction (sfy)
##Physical fragility (pf)
#Distance parameter among the columns (dp)
#Intensity parameter per structure deformation (di)
#Intensity parameter per structure depth (sd)
#Intensity parameter per structure depth foundation, depending on the 
#location of the exposed element (Zone 1, 2, 3 or 4) (sf)
#Relationship among parameters per structure depth and the intensity parameter 
#per structure depth foundation (rsi)
#Intensity parameter per depth (ipd)
#Landslide intensity (sli)
#Physical vulnerability in landslides (pv)
#Physical vulnerability assessment (pvl)

#All of them were calculated based on the guide and the #specialization thesis abovementioned.


#Definition of the structural fragility per typology (sfp)
Exposed_elements$sfp <- NA
styp_rGI_GII<-Exposed_elements[67]
styp_rm<-Exposed_elements[68]
styp_ph<-Exposed_elements[69]
styp_lg<-Exposed_elements[70]
styp_sc<-Exposed_elements[71]

for(i in 1:length(Exposed_elements$ID)){
  if(!is.na(Exposed_elements$Styp_rGI_GII[i])){
    Exposed_elements$sfp[i] <- 0.3
  }  
}

for(i in 1:length(Exposed_elements$ID)){
  if(!is.na(Exposed_elements$Styp_rm[i])){
    Exposed_elements$sfp[i] <- 0.50
  }  
}

for(i in 1:length(Exposed_elements$ID)){
  if(!is.na(Exposed_elements$Styp_ph[i])){
    Exposed_elements$sfp[i] <- 0.70
  }  
}

for(i in 1:length(Exposed_elements$ID)){
  if(!is.na(Exposed_elements$Styp_lg[i])){
    Exposed_elements$sfp[i] <- 0.9
  }  
}

for(i in 1:length(Exposed_elements$ID)){
  if(!is.na(Exposed_elements$Styp_sc[i])){
    Exposed_elements$sfp[i] <- 1
  }  
}

#Definition of the structural fragility per building's height (sfb)
Exposed_elements$sfb <- 0.05

for(i in 1:length(Exposed_elements$ID)){
  if(!is.na(Exposed_elements$Styp_sc[i])){
    Exposed_elements$sfb[i] <- 0.90
  }  
}

for(i in 1:length(Exposed_elements$ID)){
  if(!is.na(Exposed_elements$Styp_lg[i])){
    Exposed_elements$sfb[i] <- 0.90
  }  
}

for(i in 1:length(Exposed_elements$ID)){
  if(!is.na(Exposed_elements$Styp_ph[i])){
    Exposed_elements$sfb[i] <- 0.60
  }  
}

#Definition of the structural fragility due to conservation (sfc)
Exposed_elements$sfc <- 0.25

for(i in 1:length(Exposed_elements$ID)){
  if(!is.na(Exposed_elements$Cc_nd[i])){
    Exposed_elements$sfc[i] <- 0.05
  }  
}

##Definition of the structural fragility due to the year of construction (sfy)
Exposed_elements$sfa <- Exposed_elements$Yrc/30
Exposed_elements$sfy <- NA

Exposed_elements$sfy[Exposed_elements$sfa<=0.1] <- 0.05
Exposed_elements$sfy[Exposed_elements$sfa>0.1 & Exposed_elements$sfa<0.4] <- 0.10
Exposed_elements$sfy[Exposed_elements$sfa>0.4 & Exposed_elements$sfa<0.6] <- 0.30
Exposed_elements$sfy[Exposed_elements$sfa>0.6 & Exposed_elements$sfa<0.8] <- 0.50
Exposed_elements$sfy[Exposed_elements$sfa>0.8 & Exposed_elements$sfa<1] <- 0.70
Exposed_elements$sfy[Exposed_elements$sfa>1 & Exposed_elements$sfa<1.2] <- 0.80
Exposed_elements$sfy[Exposed_elements$sfa>1 & Exposed_elements$sfa<1.2] <- 0.80
Exposed_elements$sfy[Exposed_elements$sfa>=1.2] <- 1

##Physical fragility (pf)
Exposed_elements$pf = (1-((1-Exposed_elements$sfp)* (1-Exposed_elements$sfb) *
  (1-Exposed_elements$sfc)))

#Distance parameter among the columns (dp)
Exposed_elements$dp=2

#Intensity parameter per structure deformation (di)
Exposed_elements$di= 0.1

#Intensity parameter per structure depth (sd)
Exposed_elements$sd <- NA

for(i in 1:length(Exposed_elements$ID)){
  if(!is.na(Exposed_elements$Eelz_1[i])){
    Exposed_elements$sd[i] <- 1 
  }  
}

for(i in 1:length(Exposed_elements$ID)){
  if(!is.na(Exposed_elements$Eelz_2[i])){
    Exposed_elements$sd[i] <- 1.8 
  }  
}

for(i in 1:length(Exposed_elements$ID)){
  if(!is.na(Exposed_elements$Eelz_3[i])){
    Exposed_elements$sd[i] <- 1 
  }  
}

for(i in 1:length(Exposed_elements$ID)){
  if(!is.na(Exposed_elements$Eelz_4[i])){
    Exposed_elements$sd[i] <- 0 
  }  
}

#Intensity parameter per structure depth foundation, depending on the location of the exposed element (Zone 1, 2, 3 or 4) (sf)
#Zone 1 = Stable area located on the upper part of the slope
#Zone 2 = Unstable area prone to landslides
#Zone 3 = Landslide deposit area
#Zone 4 = Non-landslide threat area
Exposed_elements$sf<- NA

for(i in 1:length(Exposed_elements$ID)){
  if(!is.na(Exposed_elements$Eelz_1[i])){
    Exposed_elements$sf[i] <- 0.3 
  }  
}

for(i in 1:length(Exposed_elements$ID)){
  if(!is.na(Exposed_elements$Eelz_2[i])){
    Exposed_elements$sf[i] <- 0.3 
  }  
}

for(i in 1:length(Exposed_elements$ID)){
  if(!is.na(Exposed_elements$Eelz_3[i])){
    Exposed_elements$sf[i] <- 1 
  }  
}

for(i in 1:length(Exposed_elements$ID)){
  if(!is.na(Exposed_elements$Eelz_4[i])){
    Exposed_elements$sf[i] <- 0 
  }  
}

#Relationship among parameters per structure depth and the intensity parameter per structure depth foundation (rsi)
Exposed_elements$rsi =  Exposed_elements$sd/Exposed_elements$sf

#Intensity parameter per depth (ipd)
Exposed_elements$ipd<- ((1.44*((Exposed_elements$rsi)^-2)))

#Landslide intensity (sli)
Exposed_elements$sli <- (1-((1-Exposed_elements$di)*(1-Exposed_elements$ipd)))

#Physical vulnerability in landslides (pv)
Exposed_elements$pv<-((1-((1/2)*(((1-Exposed_elements$sli)/Exposed_elements$pf)^2))))

#Physical vulnerability assessment (pvl)
Exposed_elements$pvl <- "Low"
Exposed_elements$pvl [Exposed_elements$pv> 0.50 & Exposed_elements$pv<1] <- "High"
Exposed_elements$pvl [Exposed_elements$pv> 0.10 & Exposed_elements$pv<0.50] <- "Medium"

##########################################################################
#4.Risk assessment 
#As a result of the hazard and physical vulnerability indexes, the risk assessment was obtained in terms of potential losses.
#Thus, a set of indexes were calculated based on the guide and the specialization thesis abovementioned.
#A list of the field's abbreviation is attached in the repository.
#The set of indexes are:

#Risk calculation in terms of potential losses (pl)
#Damage percentage relation (dam)
#Damage percentage (damp)
#Physical risk categorization (rsk)
#Potential losses from Colombian Pesos into Euro (ple)
#Number of exposed elements in high risk (Hrisk_level)
#Number of exposed elements in low risk (Lrisk_level)


#Risk calculation in terms of potential losses (pl)
costs<-as.numeric(Exposed_elements$V_2)
Exposed_elements$pl = Exposed_elements$sli*Exposed_elements$pv*costs

#Damage percentage relation (dam)
Exposed_elements$dam = ((Exposed_elements$pl*100)/costs)

#Damage percentage (damp)
Exposed_elements$damp <- -1* (Exposed_elements$pl - ((Exposed_elements$dam/100)*Exposed_elements$pl))

#Physical risk categorization (rsk)
Exposed_elements$rsk <- "Low"
Exposed_elements$rsk [Exposed_elements$dam> 60 & Exposed_elements$pv<200] <- "High"
Exposed_elements$rsk [Exposed_elements$pv> 20 & Exposed_elements$pv<60] <- "Medium"

#Potential losses from Colombian Pesos into Euro (ple)
Exposed_elements$ple = Exposed_elements$damp/4094.03 

#Number of exposed elements in high risk (Hrisk_level)
Hrisk_level<- Exposed_elements %>%
  filter(Exposed_elements$rsk %in% c("High"))

#Number of exposed elements in low risk (Lrisk_level)
Lrisk_level<- Exposed_elements %>%
  filter(Exposed_elements$rsk %in% c("Low"))

##########################################################################
#5.Geolocation of the exposed elements with high risk Physical risk geolocation of the 455 exposed elements in high risk level
leaflet() %>%
  addProviderTiles(
    provider = providers$Esri.WorldImagery)%>%
  addPolygons(data = hazard,
              weight=1,
              smoothFactor = 0.5,
              color="Black",
              fillOpacity = 0.5,
              fillColor = pal(hazard$H))%>%
  
  addPulseMarkers(lng = Hrisk_level$Long,
                  lat = Hrisk_level$Lat,
                  popup = paste0("<h2>Exposed_elements</h2>","<hr/>",
                                 "Physical vulnerability level:",Hrisk_level$pvl,"<hr/>", 
                                 "Physical risk level:", Hrisk_level$rsk,"<hr/>"),
                  icon = makePulseIcon(heartbeat =1, iconSize = 2, color = "Yellow"))%>%
  addScaleBar() %>%
  addMiniMap()

##########################################################################
#6.Statistical analysis
#The last part of the script was focused analysing the risk in terms of potential losses on the exposed elements classified as high risk.

#The analysis is divided into the following components:

#Number of exposed elements per risk category
#Distribution of the potential losses per district.
#Distribution of the potential losses per neighborhood
#Distribution of the exposed goods in high risk level per district
#Distribution of the exposed goods in high risk level per neighborhood
#Shapefile of the exposed goods with the final results


#Number of exposed elements per risk category
#455 exposed elements were categorized in high risk
summary (Hrisk_level)
#569 exposed elements were categorized in low risk
summary(Lrisk_level)
summary(Hrisk_level$ple)


#Distribution of the potential losses per district.
#Two of the exposed elements correspond to local schools. Therefore, they were omitted for the purpose of this project.
Hexp <- rownames(Hrisk_level)
Potl <- Hrisk_level$ple
Neighb <- Hrisk_level$Nghbr
Districts <- Hrisk_level$Dstrc

#Violin graphic of the goods in high risk level
ggplot(Hrisk_level, aes(x=1, y=Potl, col = Districts))+
  geom_violin(alpha=.5)+
  labs(title = "Potential losses of the exposed elements in high risk level per district", 
       x="No. exposed element at high risk", y="Potential losses (Euro)")+
  scale_y_continuous(limits = c(0,1000),breaks = seq(0,1000,200))+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank())  
ggsave("Potential_Losses.png", width = 30, height = 18, units = "cm")

#Box graphic of the goods in high risk level
ggplot(Hrisk_level, aes(x=Districts, y=Potl, col = Districts))+
  geom_boxplot()+
  labs(title = "Distribution of potential losses in high risk level", 
       x="No. exposed element at high risk", y="Potential losses (Euro)") +
  scale_y_continuous(limits = c(0,1000),breaks = seq(0,1000,200))+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) 
ggsave("Potential_Losses_box.png", width = 30, height = 18, units = "cm")

#Distribution of the potential losses per neighborhood
#Organized by median values
ggplot(Hrisk_level, aes(x= reorder(Neighb,-Potl,FUN=median), y=Potl, col = Neighb))+geom_boxplot()+
  labs(title = "Potential_losses_neighborhood", 
       x="No. exposed element at high risk", y="Potential losses (Euro)") +
  scale_y_continuous(limits = c(0,1000),breaks = seq(0,1000,200))+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank())  
ggsave("Potential_Losses_box.png", width = 30, height = 18, units = "cm")

#Distribution of potential losses per district
ggplot(Hrisk_level)+
  geom_bar(aes(x=Districts,y=Potl), stat = "identity", fill=alpha("blue",0.1)) +
  coord_polar(start = 0)+
  theme(axis.text.x = element_text(angle=90,
                                   size=8,
                                   color="Red"))+
  labs(title = "Distribution of potential losses per district", 
       x="No. exposed element at high risk", y="Potential losses (Euro)")
ggsave("Potential__losses_district.png", width = 30, height = 18, units = "cm")

#Distribution of potential losses per neighborhood
ggplot(Hrisk_level)+
  geom_bar(aes(x=Neighb,y=Potl), stat = "identity", fill=alpha("blue",0.1)) +
  coord_polar(start = 0) +
  theme(axis.text.x = element_text(angle=0,
                                   size=5,
                                   color="Red"))+
  labs(title = "Distribution of potential losses per neighborhood", 
       x="No. exposed element at high risk", y="Potential losses (Euro)")
ggsave("Houses_neighborhood.png", width = 30, height = 18, units = "cm")

#Shapefile of the exposed goods with the final results
#Data frame to Spatial Data. Convert the exposed elements dataframe to a spatial object
#Indexing the coordinates from the dataframe
coord<-Exposed_elements
spdf.obj<-coord
names(spdf.obj)
coordinates(spdf.obj)<-~Long+Lat
proj4string(spdf.obj)<-CRS("+init=epsg:4326")
class(coordinates(spdf.obj))
writeOGR(spdf.obj,"exposed_elements.shp",driver="ESRI Shapefile","data")

##########################################################################
#References
#This script was based on the following documents
#http://rstudio.github.io/leaflet/
#https://www.mdpi.com/2220-9964/6/10/317
#https://books.google.com.pe/books?id=sk5UHK-FJM8C